<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>禧禧打字網 - XixiTyping</title>
<link href="https://fonts.googleapis.com/css2?family=Iansui&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px}
body{font-family:'Iansui','芫荽','Segoe UI','Malgun Gothic','맑은 고딕',sans-serif;background:#f3f4f6;color:#1f2937;min-height:100vh;display:flex;flex-direction:column}
a{color:#2563eb;text-decoration:none}a:hover{text-decoration:underline}
button{cursor:pointer;border:none;border-radius:6px;padding:8px 18px;font-size:.9rem;font-weight:600;transition:opacity .15s}button:hover{opacity:.85}
input,select,textarea{border:1px solid #d1d5db;border-radius:6px;padding:8px 12px;font-size:.9rem;outline:none;transition:border-color .2s}
input:focus,select:focus,textarea:focus{border-color:#2563eb}
.header{background:#1e293b;color:#f8fafc;padding:12px 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
.header h1{font-size:1.25rem;font-weight:700;letter-spacing:-.5px;cursor:pointer;user-select:none}.header h1:hover{opacity:.8}.header h1 span{color:#60a5fa}
.header-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.header-right button{background:#334155;color:#e2e8f0;padding:6px 14px;font-size:.8rem}
.header-right .btn-accent{background:#2563eb;color:#fff}.header-right .user-info{color:#94a3b8;font-size:.85rem}
.tabs{display:flex;background:#e2e8f0;padding:0;border-bottom:2px solid #cbd5e1}
.tab-btn{background:transparent;color:#475569;padding:10px 24px;border-radius:0;font-size:.9rem;border-bottom:3px solid transparent;margin-bottom:-2px}
.tab-btn.active{background:#fff;color:#1e293b;border-bottom-color:#2563eb;font-weight:700}
.main{flex:1;max-width:960px;width:100%;margin:0 auto;padding:20px}
.tab-panel{display:none}.tab-panel.active{display:block}
.practice-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:16px;justify-content:center}
.practice-controls select{min-width:120px}.practice-controls #textSelect{min-width:200px}
.btn-start{background:#2563eb;color:#fff}.btn-reset{background:#64748b;color:#fff}.btn-stop{background:#dc2626;color:#fff}
/* #2: stats bar sticky */
.stats-bar{display:flex;gap:16px;flex-wrap:wrap;background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:10px 16px;margin-bottom:16px;font-size:.85rem;justify-content:center;position:sticky;top:0;z-index:40;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.stat-item{display:flex;align-items:center;gap:4px}.stat-label{color:#64748b;font-weight:500}.stat-value{color:#1e293b;font-weight:700;font-variant-numeric:tabular-nums}
.pause-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:100;justify-content:center;align-items:center;font-size:1.4rem;color:#fff;font-weight:700}
.pause-overlay.active{display:flex}
.prep-area{background:#fef9c3;border:2px dashed #d97706;border-radius:8px;padding:10px 16px;margin-bottom:12px;display:flex;align-items:center;gap:12px}
.prep-area .prep-label{color:#92400e;font-size:.9rem;font-weight:600;white-space:nowrap}
.prep-area .prep-input{flex:1;border:1px dashed #d97706;background:#fffef5;border-radius:4px;padding:8px 12px;font-size:1.05rem;font-family:var(--pf)}
.prep-area .prep-input:focus{border-color:#b45309;outline:none}
:root{--pf:'Iansui','芫荽','D2Coding','Noto Sans KR','Consolas','Malgun Gothic',monospace;--pfs:18px;--plh:2;--pls:0.5px;--ppad:10px 14px}
.line-practice-wrapper{position:relative}.line-practice-area{margin-bottom:16px}.line-block{margin-bottom:2px}
.line-original{background:#fffbeb;border:1px solid #e5e7eb;border-bottom:none;border-radius:6px 6px 0 0;padding:var(--ppad);font-size:var(--pfs);line-height:var(--plh);letter-spacing:var(--pls);font-family:var(--pf);word-break:break-all;white-space:pre-wrap;min-height:28px;color:#6b21a8}
.line-original .ch{color:#6b21a8;transition:color .05s}.line-original .ch.correct{color:#16a34a}
.line-original .ch.incorrect{color:#fff;background:#ef4444;border-radius:2px}.line-original .ch.current{border-bottom:2px solid #2563eb;color:#6b21a8}
.line-original .ch.space-incorrect{background:#fca5a5;border-radius:2px}
.line-block.completed .line-original{background:#d9f99d;border-color:#84cc16}
.line-block.completed .line-input{background:#f0fdf4;border-color:#84cc16;color:#166534}
.line-input{width:100%;display:block;border:2px dashed #d1d5db;border-radius:0 0 6px 6px;padding:var(--ppad);font-size:var(--pfs);line-height:var(--plh);letter-spacing:var(--pls);font-family:var(--pf);outline:none;transition:border-color .2s,background .2s;margin-bottom:6px;background:#fff}
.line-input:focus{border-color:#2563eb;border-style:solid;background:#eff6ff}
.line-input:disabled{background:#f9fafb;color:#9ca3af;cursor:not-allowed;border-style:dashed}
.line-input.active-line{border-color:#2563eb;border-style:solid;background:#eff6ff}
.practice-msg{text-align:center;color:#64748b;padding:40px 0;font-size:1rem}
.hotkey-hint{text-align:center;color:#94a3b8;font-size:.8rem;margin-top:8px}
.settings-section{background:#fff;border-radius:8px;padding:20px;border:1px solid #e2e8f0;margin-bottom:16px}
.settings-section h3{font-size:1rem;margin-bottom:12px;color:#1e293b}
.settings-row{display:flex;align-items:center;gap:12px;margin-bottom:10px;flex-wrap:wrap}
.settings-row label{font-size:.9rem;color:#475569;min-width:120px;font-weight:500}
.admin-text-list{max-height:500px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px}
.admin-text-item{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #f1f5f9;gap:8px}
.admin-text-item:last-child{border-bottom:none}.admin-text-item:hover{background:#f8fafc}
.admin-text-info{flex:1;min-width:0}.admin-text-title{font-weight:600;font-size:.9rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.admin-text-meta{font-size:.75rem;color:#94a3b8}.admin-text-actions{display:flex;gap:6px;flex-shrink:0}
.admin-text-actions button{padding:4px 10px;font-size:.75rem}
.ranking-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
.ranking-table-wrap{background:#fff;border:1px solid #e2e8f0;border-radius:8px;overflow-x:auto}
.ranking-table{width:100%;border-collapse:collapse;font-size:.85rem}
.ranking-table th{background:#f1f5f9;color:#475569;font-weight:600;padding:10px 12px;text-align:left;border-bottom:2px solid #e2e8f0;white-space:nowrap}
.ranking-table td{padding:8px 12px;border-bottom:1px solid #f1f5f9;white-space:nowrap}
.ranking-table tbody tr:hover{background:#f8fafc}.rank-num{color:#2563eb;font-weight:700}
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.45);z-index:1000;justify-content:center;align-items:center}
.modal-overlay.active{display:flex}
.modal{background:#fff;border-radius:12px;padding:28px;min-width:340px;max-width:560px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.25);max-height:90vh;overflow-y:auto}
.modal h2{font-size:1.15rem;margin-bottom:18px;color:#1e293b}
.modal-field{margin-bottom:14px}.modal-field label{display:block;font-size:.85rem;color:#475569;margin-bottom:4px;font-weight:500}
.modal-field input,.modal-field select,.modal-field textarea{width:100%}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}
.btn-primary{background:#2563eb;color:#fff}.btn-secondary{background:#e2e8f0;color:#475569}.btn-danger{background:#dc2626;color:#fff}
.modal-msg{color:#dc2626;font-size:.85rem;margin-top:8px;min-height:20px}.modal-msg.success{color:#16a34a}
.results-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0}
.result-card{background:#f8fafc;border-radius:8px;padding:14px;text-align:center}
.result-card .r-label{font-size:.8rem;color:#64748b;margin-bottom:4px}
.result-card .r-value{font-size:1.4rem;font-weight:700;color:#1e293b}.result-card .r-value.highlight{color:#2563eb}
.footer{text-align:center;padding:16px;color:#94a3b8;font-size:.8rem;border-top:1px solid #e2e8f0}
/* Scroll buttons - #10: prevent focus steal */
.scroll-btn{position:fixed;right:12px;z-index:50;width:40px;height:40px;border-radius:50%;background:#334155;color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.2rem;box-shadow:0 2px 8px rgba(0,0,0,.2);opacity:.6;transition:opacity .2s}
.scroll-btn:hover{opacity:1}
.scroll-btn.up{bottom:68px}.scroll-btn.down{bottom:20px}
.admin-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
.admin-controls select{min-width:100px}
.admin-count{font-size:.85rem;color:#475569;font-weight:500}
@media(max-width:600px){.header{padding:10px 14px}.main{padding:12px}.stats-bar{gap:8px;padding:8px 10px;font-size:.78rem}.tab-btn{padding:8px 14px;font-size:.8rem}.prep-area{flex-direction:column;gap:6px}}
</style>
</head>
<body>
<div class="header"><h1 onclick="location.reload()"><span>禧禧</span>打字網</h1>
<div class="header-right"><span class="user-info" id="userInfo">로그인하지 않음</span>
<button id="btnLogin" class="btn-accent" onclick="showLoginModal()">로그인</button>
<button id="btnSignup" onclick="showSignupModal()">회원가입</button>
<button id="btnLogout" style="display:none" onclick="doLogout()">로그아웃</button></div></div>

<div class="tabs" id="tabBar">
<button class="tab-btn active" data-tab="practice">연습</button>
<button class="tab-btn" data-tab="ranking">랭킹</button>
<button class="tab-btn" data-tab="settings">설정</button>
<button class="tab-btn" data-tab="account">계정</button>
<button class="tab-btn" data-tab="admin" id="tabAdmin" style="display:none">관리</button>
</div>

<div class="main">
<!-- Practice -->
<div class="tab-panel active" id="panel-practice">
<div class="practice-controls">
<select id="langSelect"><option value="">전체</option></select>
<select id="textSelect"><option value="">텍스트를 선택해 주세요</option></select>
<button class="btn-start" onclick="startPractice()">시작 (F10)</button>
<button class="btn-reset" onclick="resetPractice()">초기화 (F11)</button>
</div>
<!-- #2: stats bar with extra stats, sticky -->
<div class="stats-bar" id="statsBar" style="display:none">
<div class="stat-item"><span class="stat-label">시간</span><span class="stat-value" id="statTime">0:00</span></div>
<div class="stat-item"><span class="stat-label">CPM</span><span class="stat-value" id="statCpm">0</span></div>
<div class="stat-item"><span class="stat-label">타수(KPM)</span><span class="stat-value" id="statKpm">0</span></div>
<div class="stat-item"><span class="stat-label">정확도</span><span class="stat-value" id="statAcc">0%</span></div>
<div class="stat-item"><span class="stat-label">진행률</span><span class="stat-value" id="statProgress">0%</span></div>
<div class="stat-item"><span class="stat-label">입력글자</span><span class="stat-value" id="statChars">0</span></div>
<div class="stat-item"><span class="stat-label">총타수</span><span class="stat-value" id="statKeys">0</span></div>
<div class="stat-item" id="pauseStatus" style="display:none"><span class="stat-value" style="color:#dc2626">⏸ 일시정지</span></div>
</div>
<div id="practiceArea" style="display:none">
<div class="prep-area" id="prepArea"><span class="prep-label">準備區：</span><input class="prep-input" id="prepInput" placeholder="在這裡調整輸入法，按 Enter/↓ 開始計時"></div>
<div class="line-practice-wrapper"><div class="line-practice-area" id="linePracticeArea"></div></div>
<div class="hotkey-hint">Enter/Space(행끝): 다음 행 | Tab/Shift+Tab/↑↓: 행 이동 | BackSpace(행앞): 이전 행 | ESC: 일시정지</div>
</div>
<div class="practice-msg" id="practiceMsg">위에서 텍스트를 선택하고 <strong>시작</strong>을 누르세요.</div>
</div>

<!-- Ranking -->
<div class="tab-panel" id="panel-ranking">
<div class="ranking-controls"><select id="rankBoardSelect"><option value="">전체</option></select>
<button class="btn-primary" onclick="loadRankings()" style="padding:6px 14px;font-size:.85rem">새로고침</button></div>
<div class="ranking-table-wrap"><table class="ranking-table">
<thead><tr><th>#</th><th>닉네임</th><th>타자기</th><th>CPM</th><th>타수</th><th>정확도</th><th>진행률</th><th>텍스트</th><th>날짜</th></tr></thead>
<tbody id="rankBody"><tr><td colspan="9" style="text-align:center;padding:30px;color:#94a3b8">로딩 중...</td></tr></tbody>
</table></div></div>

<!-- Settings -->
<div class="tab-panel" id="panel-settings">
<div class="settings-section"><h3>연습 단위</h3>
<div class="settings-row"><label>표시 형식</label>
<select id="settingUnitMode"><option value="line">행 단위 (줄마다 분할)</option><option value="paragraph">문단 단위 (원본 줄바꿈 유지)</option></select></div>
<p style="font-size:.8rem;color:#94a3b8;margin-top:4px">※ '행 단위'는 긴 문단을 창 너비에 맞게 여러 줄로 분할합니다.</p></div>
<div class="settings-section"><h3>폰트 크기</h3>
<div class="settings-row"><label>원문/입력</label><input type="number" id="settingFontSize" value="18" min="12" max="40" step="1" style="width:80px"><span style="font-size:.85rem;color:#94a3b8">px</span></div></div>
<div class="settings-section"><h3>줄 간격</h3>
<div class="settings-row"><label>line-height</label><input type="number" id="settingLineHeight" value="2" min="1.2" max="3" step="0.1" style="width:80px"></div></div>
<div class="settings-section"><h3>자간</h3>
<div class="settings-row"><label>letter-spacing</label><input type="number" id="settingLetterSpacing" value="0.5" min="0" max="5" step="0.1" style="width:80px"><span style="font-size:.85rem;color:#94a3b8">px</span></div></div>
<!-- #3: SFX settings matching PC version -->
<div class="settings-section"><h3>키 입력 효과음</h3>
<div class="settings-row"><label>효과음</label>
<select id="settingSfxEnabled"><option value="on">켜기</option><option value="off">끄기</option></select></div>
<div class="settings-row"><label>효과음 종류</label>
<select id="settingSfxStyle"><option value="typewriter">전통 타자기</option><option value="retro">레트로</option><option value="analog">아날로그</option><option value="mechanical">기계음</option><option value="soft">소프트</option></select></div>
<div class="settings-row"><label>음량</label><input type="range" id="settingSfxVolume" min="0" max="100" value="50" style="width:160px"><span id="sfxVolLabel" style="font-size:.85rem;color:#94a3b8;min-width:35px">50%</span></div>
</div>
</div>

<!-- Account -->
<div class="tab-panel" id="panel-account">
<div id="accountLoggedOut"><div class="practice-msg">로그인하면 랭킹 등록 등의 기능을 사용할 수 있습니다.<br><br>
<button class="btn-primary" onclick="showLoginModal()">로그인</button> <button class="btn-secondary" onclick="showSignupModal()">회원가입</button></div></div>
<div id="accountLoggedIn" style="display:none"><div style="background:#fff;border-radius:8px;padding:24px;border:1px solid #e2e8f0">
<h3 style="margin-bottom:16px">계정 정보</h3>
<p style="margin-bottom:8px"><strong>ID:</strong> <span id="acctId">-</span></p>
<p style="margin-bottom:20px"><strong>닉네임:</strong> <span id="acctNick">-</span></p>
<div style="display:flex;gap:10px;flex-wrap:wrap">
<button class="btn-secondary" onclick="showFindIdModal()">아이디 찾기</button>
<button class="btn-secondary" onclick="showResetPwModal()">비밀번호 재설정</button>
<button class="btn-danger" onclick="showDeleteAccountModal()">회원탈퇴</button></div></div></div></div>

<!-- #6: Admin with count display -->
<div class="tab-panel" id="panel-admin">
<div class="settings-section"><h3>서버 텍스트 관리 <span class="admin-count" id="adminTotalCount"></span></h3>
<div class="admin-controls">
<button class="btn-primary" onclick="showAddTextModal()">새 텍스트 추가</button>
<button class="btn-secondary" onclick="refreshAdminTextList()">새로고침</button>
<select id="adminLangFilter"><option value="">전체</option></select>
<button class="btn-secondary" onclick="adminSelectAll(true)" style="padding:5px 10px;font-size:.8rem">전체 선택</button>
<button class="btn-secondary" onclick="adminSelectAll(false)" style="padding:5px 10px;font-size:.8rem">전체 해제</button>
<button class="btn-danger" onclick="adminDeleteSelected()" style="padding:5px 10px;font-size:.8rem">선택 삭제</button>
<span class="admin-count" id="adminSelCount"></span>
</div>
<div class="admin-text-list" id="adminTextList"><div style="padding:20px;text-align:center;color:#94a3b8">로딩 중...</div></div></div></div>
</div>

<div class="footer">禧禧打字網 (XixiTyping) — 웹 버전</div>

<!-- #10: scroll buttons with onmousedown preventDefault to not steal focus -->
<button class="scroll-btn up" onmousedown="event.preventDefault();window.scrollTo({top:0,behavior:'smooth'})" title="맨 위로">▲</button>
<button class="scroll-btn down" onmousedown="event.preventDefault();window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'})" title="맨 아래로">▼</button>

<!-- Modals -->
<div class="modal-overlay" id="loginModal"><div class="modal"><h2>로그인</h2>
<div class="modal-field"><label>ID</label><input id="loginId" autocomplete="username"></div>
<div class="modal-field"><label>비밀번호</label><input id="loginPw" type="password" autocomplete="current-password"></div>
<div class="modal-msg" id="loginMsg"></div>
<div class="modal-actions"><button class="btn-secondary" onclick="closeModal('loginModal')">취소</button><button class="btn-primary" onclick="doLogin()">로그인</button></div></div></div>

<div class="modal-overlay" id="signupModal"><div class="modal"><h2>회원가입</h2>
<div class="modal-field"><label>ID (3자 이상)</label><input id="signupId" autocomplete="username"></div>
<div class="modal-field"><label>비밀번호 (4자 이상)</label><input id="signupPw" type="password" autocomplete="new-password"></div>
<div class="modal-field"><label>닉네임 (10자 이하)</label><input id="signupNick"></div>
<div class="modal-field"><label>이메일</label><input id="signupEmail" type="email"></div>
<div class="modal-msg" id="signupMsg"></div>
<div class="modal-actions"><button class="btn-secondary" onclick="closeModal('signupModal')">취소</button><button class="btn-primary" onclick="doSignup()">가입</button></div></div></div>

<div class="modal-overlay" id="resultsModal"><div class="modal"><h2>연습 결과</h2>
<div class="results-grid">
<div class="result-card"><div class="r-label">CPM (타/분)</div><div class="r-value highlight" id="resCpm">0</div></div>
<div class="result-card"><div class="r-label">타수 (KPM)</div><div class="r-value" id="resKpm">0</div></div>
<div class="result-card"><div class="r-label">정확도</div><div class="r-value" id="resAcc">0%</div></div>
<div class="result-card"><div class="r-label">진행률</div><div class="r-value" id="resProgress">0%</div></div>
<div class="result-card"><div class="r-label">소요 시간</div><div class="r-value" id="resTime">0초</div></div>
<div class="result-card"><div class="r-label">총 글자</div><div class="r-value" id="resChars">0</div></div></div>
<div id="rankSubmitArea" style="display:none">
<div class="modal-field"><label>타자기 구분</label><input id="resTypewriter" placeholder="예) 한글 두벌식, 倉頡, 嘸蝦米"></div>
<button class="btn-primary" onclick="submitRanking()" style="margin-top:8px;width:100%">랭킹에 등록</button>
<div class="modal-msg" id="rankSubmitMsg"></div></div>
<div class="modal-actions"><button class="btn-secondary" onclick="closeModal('resultsModal')">닫기 (Enter)</button></div></div></div>

<div class="modal-overlay" id="findIdModal"><div class="modal"><h2>아이디 찾기</h2>
<div class="modal-field"><label>이메일</label><input id="findIdEmail" type="email"></div>
<div class="modal-msg" id="findIdMsg"></div>
<div class="modal-actions"><button class="btn-secondary" onclick="closeModal('findIdModal')">닫기</button><button class="btn-primary" onclick="doFindId()">찾기</button></div></div></div>

<div class="modal-overlay" id="resetPwModal"><div class="modal"><h2>비밀번호 재설정</h2>
<div class="modal-field"><label>ID</label><input id="resetPwId"></div>
<div class="modal-field"><label>이메일</label><input id="resetPwEmail" type="email"></div>
<div class="modal-field"><label>새 비밀번호</label><input id="resetPwNew" type="password"></div>
<div class="modal-field"><label>확인</label><input id="resetPwConfirm" type="password"></div>
<div class="modal-msg" id="resetPwMsg"></div>
<div class="modal-actions"><button class="btn-secondary" onclick="closeModal('resetPwModal')">닫기</button><button class="btn-primary" onclick="doResetPw()">재설정</button></div></div></div>

<div class="modal-overlay" id="deleteAccountModal"><div class="modal"><h2>회원탈퇴</h2>
<p style="color:#dc2626;font-weight:600;margin-bottom:16px">계정과 랭킹이 모두 삭제됩니다.</p>
<div class="modal-field"><label>비밀번호</label><input id="delAcctPw" type="password"></div>
<div class="modal-field"><label>'탈퇴' 입력</label><input id="delAcctConfirm"></div>
<div class="modal-msg" id="delAcctMsg"></div>
<div class="modal-actions"><button class="btn-secondary" onclick="closeModal('deleteAccountModal')">취소</button><button class="btn-danger" onclick="doDeleteAccount()">탈퇴</button></div></div></div>

<div class="modal-overlay" id="editTextModal"><div class="modal" style="max-width:640px"><h2 id="editTextTitle">텍스트 편집</h2>
<input type="hidden" id="editTextId">
<div class="modal-field"><label>제목</label><input id="editTextName"></div>
<div class="modal-field"><label>언어</label><select id="editTextLang"><option>한국어</option><option>中文</option><option>영어</option><option>日本語</option></select></div>
<div class="modal-field"><label>내용</label><textarea id="editTextContent" rows="12" style="font-family:var(--pf);font-size:.85rem;line-height:1.6"></textarea></div>
<div class="modal-msg" id="editTextMsg"></div>
<div class="modal-actions">
<button class="btn-danger" id="btnDeleteText" onclick="doDeleteText()" style="margin-right:auto">삭제</button>
<button class="btn-secondary" onclick="closeModal('editTextModal')">취소</button>
<button class="btn-primary" onclick="doSaveText()">저장</button></div></div></div>

<div class="pause-overlay" id="pauseOverlay">⏸ 일시정지 — 아무 키를 누르거나 클릭하면 재개</div>

<script>
const API='',ADMIN_ID='zhengxi980';
let currentUser=null,allTexts=[],texts=[],languages=[];
let currentText=null,practicing=false,started=false,paused=false;
let startTime=null,timerInterval=null,keystrokes=0;
let totalPausedMs=0,pauseStartTime=null;
let lines=[],currentLineIdx=0,lineInputs=[],lineDisplays=[],lineBlocks=[];
let unitMode='line',manualPause=false;
let adminAllTexts=[];

/* #3: SFX — use actual WAV files served from /static/sfx/ */
let sfxEnabled=false, sfxStyle='typewriter', sfxVolume=0.5;
const sfxBuffers={};
let sfxCtx=null;
const SFX_URLS={
  typewriter:'/static/sfx/sfx_typewriter.wav',
  retro:'/static/sfx/sfx_retro.wav',
  analog:'/static/sfx/sfx_analog.wav',
  mechanical:'/static/sfx/sfx_mechanical.wav'
};
async function loadSfxBuffer(key){
  if(sfxBuffers[key])return;
  try{
    if(!sfxCtx)sfxCtx=new(window.AudioContext||window.webkitAudioContext)();
    const url=SFX_URLS[key];if(!url)return;
    const resp=await fetch(url);const ab=await resp.arrayBuffer();
    sfxBuffers[key]=await sfxCtx.decodeAudioData(ab);
  }catch(e){}
}
function playSfx(){
  if(!sfxEnabled)return;
  try{
    if(!sfxCtx)sfxCtx=new(window.AudioContext||window.webkitAudioContext)();
    /* "soft" uses synthesized sound; others use WAV buffers */
    if(sfxStyle==='soft'){
      const o=sfxCtx.createOscillator(),g=sfxCtx.createGain();
      o.connect(g);g.connect(sfxCtx.destination);const t=sfxCtx.currentTime;
      o.type='sine';o.frequency.setValueAtTime(600,t);
      g.gain.setValueAtTime(sfxVolume*0.15,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.04);
      o.start(t);o.stop(t+0.04);return;
    }
    const buf=sfxBuffers[sfxStyle];
    if(!buf){loadSfxBuffer(sfxStyle);return;}
    const src=sfxCtx.createBufferSource(),g=sfxCtx.createGain();
    src.buffer=buf;src.connect(g);g.connect(sfxCtx.destination);
    g.gain.value=sfxVolume;src.start(0);
  }catch(e){}
}
/* preload all SFX buffers */
function preloadAllSfx(){for(const k of Object.keys(SFX_URLS))loadSfxBuffer(k);}

function normalizeFullwidth(s){let o='';for(let i=0;i<s.length;i++){const c=s.charCodeAt(i);if(c>=0xFF10&&c<=0xFF19)o+=String.fromCharCode(c-0xFEE0);else if(c>=0xFF21&&c<=0xFF3A)o+=String.fromCharCode(c-0xFEE0);else if(c>=0xFF41&&c<=0xFF5A)o+=String.fromCharCode(c-0xFEE0);else o+=s[i];}return o;}

/* #9: strip leading whitespace (full-width space, half-width space, tab, NBSP, etc.) */
function stripLeadingBlanks(s){return s.replace(/^[\s\u3000\u00A0\t\u0020]+/,'');}

async function api(ep,method='GET',data=null){const o={method,headers:{'Content-Type':'application/json'}};if(currentUser?.token)o.headers['Authorization']='Bearer '+currentUser.token;if(data)o.body=JSON.stringify(data);try{const r=await fetch(API+ep,o);return await r.json();}catch(e){return null;}}

/* Tabs */
document.querySelectorAll('.tab-btn').forEach(b=>{b.addEventListener('click',()=>{
  const prevTab=document.querySelector('.tab-btn.active')?.dataset.tab;
  document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  document.getElementById('panel-'+b.dataset.tab).classList.add('active');
  if(b.dataset.tab==='ranking')loadRankings();
  if(b.dataset.tab==='admin')refreshAdminTextList();
  if(prevTab==='practice'&&b.dataset.tab!=='practice'&&practicing&&started&&!paused){doPause(false,true);}
  if(b.dataset.tab==='practice'&&paused&&practicing){document.getElementById('pauseOverlay').classList.add('active');}
});});

/* Auth */
function isAdmin(){return currentUser?.user_id===ADMIN_ID;}
function updateAuthUI(){const i=document.getElementById('userInfo');if(currentUser){i.textContent=currentUser.nickname+' 님';document.getElementById('btnLogin').style.display='none';document.getElementById('btnSignup').style.display='none';document.getElementById('btnLogout').style.display='';document.getElementById('accountLoggedOut').style.display='none';document.getElementById('accountLoggedIn').style.display='';document.getElementById('acctId').textContent=currentUser.user_id;document.getElementById('acctNick').textContent=currentUser.nickname;document.getElementById('rankSubmitArea').style.display='';}else{i.textContent='로그인하지 않음';document.getElementById('btnLogin').style.display='';document.getElementById('btnSignup').style.display='';document.getElementById('btnLogout').style.display='none';document.getElementById('accountLoggedOut').style.display='';document.getElementById('accountLoggedIn').style.display='none';document.getElementById('rankSubmitArea').style.display='none';}document.getElementById('tabAdmin').style.display=isAdmin()?'':'none';}
function showLoginModal(){openModal('loginModal');document.getElementById('loginId').focus();}
function showSignupModal(){openModal('signupModal');document.getElementById('signupId').focus();}
function showFindIdModal(){openModal('findIdModal');document.getElementById('findIdEmail').focus();}
function showResetPwModal(){openModal('resetPwModal');document.getElementById('resetPwId').focus();}
function showDeleteAccountModal(){openModal('deleteAccountModal');document.getElementById('delAcctPw').focus();}
async function doLogin(){const id=document.getElementById('loginId').value.trim(),pw=document.getElementById('loginPw').value;if(!id||!pw){document.getElementById('loginMsg').textContent='ID와 비밀번호를 입력하세요.';return;}const r=await api('/api/login','POST',{user_id:id,password:pw});if(r?.ok){currentUser={user_id:r.user_id,nickname:r.nickname,token:r.token};localStorage.setItem('auth',JSON.stringify(currentUser));closeModal('loginModal');updateAuthUI();}else{document.getElementById('loginMsg').textContent=r?.msg||'로그인 실패';}}
async function doSignup(){const id=document.getElementById('signupId').value.trim(),pw=document.getElementById('signupPw').value,nk=document.getElementById('signupNick').value.trim(),em=document.getElementById('signupEmail').value.trim();if(!id||!pw||!nk||!em){document.getElementById('signupMsg').textContent='모든 항목을 입력하세요.';return;}const r=await api('/api/signup','POST',{user_id:id,password:pw,nickname:nk,email:em});if(r?.ok){currentUser={user_id:r.user_id,nickname:r.nickname,token:r.token};localStorage.setItem('auth',JSON.stringify(currentUser));closeModal('signupModal');updateAuthUI();}else{document.getElementById('signupMsg').textContent=r?.msg||'실패';}}
async function doLogout(){await api('/api/logout','POST');currentUser=null;localStorage.removeItem('auth');updateAuthUI();}
async function doFindId(){const em=document.getElementById('findIdEmail').value.trim();if(!em){document.getElementById('findIdMsg').textContent='이메일을 입력하세요.';return;}const r=await api('/api/find-id','POST',{email:em});const m=document.getElementById('findIdMsg');if(r?.ok){m.className='modal-msg success';m.textContent='ID: '+r.user_id;}else{m.className='modal-msg';m.textContent=r?.msg||'없음';}}
async function doResetPw(){const id=document.getElementById('resetPwId').value.trim(),em=document.getElementById('resetPwEmail').value.trim(),p1=document.getElementById('resetPwNew').value,p2=document.getElementById('resetPwConfirm').value;if(!id||!em||!p1){document.getElementById('resetPwMsg').textContent='모든 항목 입력';return;}if(p1!==p2){document.getElementById('resetPwMsg').textContent='비밀번호 불일치';return;}const r=await api('/api/reset-password','POST',{user_id:id,email:em,new_password:p1});const m=document.getElementById('resetPwMsg');if(r?.ok){m.className='modal-msg success';m.textContent='완료';}else{m.className='modal-msg';m.textContent=r?.msg||'실패';}}
async function doDeleteAccount(){const pw=document.getElementById('delAcctPw').value,cf=document.getElementById('delAcctConfirm').value.trim();if(cf!=='탈퇴'){document.getElementById('delAcctMsg').textContent="'탈퇴' 입력 필요";return;}const r=await api('/api/delete-account','POST',{password:pw});if(r?.ok){currentUser=null;localStorage.removeItem('auth');closeModal('deleteAccountModal');updateAuthUI();alert('탈퇴 완료');}else{document.getElementById('delAcctMsg').textContent=r?.msg||'실패';}}

/* Modal helpers */
function openModal(id){document.querySelectorAll('#'+id+' .modal-msg').forEach(m=>m.textContent='');document.getElementById(id).classList.add('active');}
function closeModal(id){document.getElementById(id).classList.remove('active');}
document.addEventListener('keydown',e=>{if(e.key==='Escape'&&document.querySelector('.modal-overlay.active:not(#pauseOverlay)')){document.querySelectorAll('.modal-overlay.active:not(#pauseOverlay)').forEach(m=>m.classList.remove('active'));e.preventDefault();e.stopPropagation();return;}});
document.getElementById('loginPw')?.addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
document.getElementById('signupEmail')?.addEventListener('keydown',e=>{if(e.key==='Enter')doSignup();});

/* Texts + Language filter */
function populateTextSelect(tl,ll){allTexts=tl;languages=ll||[];const ls=document.getElementById('langSelect'),pv=ls.value;ls.innerHTML='<option value="">전체</option>';languages.forEach(l=>{const o=document.createElement('option');o.value=l;o.textContent=l;ls.appendChild(o);});ls.value=pv;filterTexts();}
function filterTexts(){const lang=document.getElementById('langSelect').value;texts=lang?allTexts.filter(t=>(t.language||'')===lang):[...allTexts];const s=document.getElementById('textSelect'),pv=s.value;s.innerHTML='<option value="">텍스트를 선택해 주세요</option>';texts.forEach(t=>{const o=document.createElement('option');o.value=t.id;o.textContent=t.title+' ('+t.content.length+'자)';s.appendChild(o);});if(pv)s.value=pv;}
document.getElementById('langSelect').addEventListener('change',filterTexts);
/* #4: auto-start when text selected */
document.getElementById('textSelect').addEventListener('change',function(){if(this.value)startPractice();});
async function loadTexts(){const r=await api('/api/texts');if(r?.ok){populateTextSelect(r.texts,r.languages);try{localStorage.setItem('cachedTexts',JSON.stringify({texts:r.texts,languages:r.languages}));}catch(e){}}}

/* Settings */
function loadSettings(){try{const s=JSON.parse(localStorage.getItem('webSettings')||'{}');unitMode=s.unitMode||'line';document.getElementById('settingUnitMode').value=unitMode;if(s.fontSize)document.getElementById('settingFontSize').value=s.fontSize;if(s.lineHeight)document.getElementById('settingLineHeight').value=s.lineHeight;if(s.letterSpacing!=null)document.getElementById('settingLetterSpacing').value=s.letterSpacing;
sfxEnabled=(s.sfxEnabled==='on');document.getElementById('settingSfxEnabled').value=sfxEnabled?'on':'off';
sfxStyle=s.sfxStyle||'typewriter';document.getElementById('settingSfxStyle').value=sfxStyle;
sfxVolume=s.sfxVolume!=null?parseFloat(s.sfxVolume)/100:0.5;document.getElementById('settingSfxVolume').value=Math.round(sfxVolume*100);document.getElementById('sfxVolLabel').textContent=Math.round(sfxVolume*100)+'%';
}catch(e){}applyFontSettings();}
function saveSettings(){const s={unitMode:document.getElementById('settingUnitMode').value,fontSize:document.getElementById('settingFontSize').value,lineHeight:document.getElementById('settingLineHeight').value,letterSpacing:document.getElementById('settingLetterSpacing').value,sfxEnabled:document.getElementById('settingSfxEnabled').value,sfxStyle:document.getElementById('settingSfxStyle').value,sfxVolume:document.getElementById('settingSfxVolume').value};unitMode=s.unitMode;sfxEnabled=(s.sfxEnabled==='on');sfxStyle=s.sfxStyle;sfxVolume=parseInt(s.sfxVolume)/100;document.getElementById('sfxVolLabel').textContent=s.sfxVolume+'%';localStorage.setItem('webSettings',JSON.stringify(s));applyFontSettings();if(sfxEnabled&&SFX_URLS[sfxStyle])loadSfxBuffer(sfxStyle);}
function applyFontSettings(){document.documentElement.style.setProperty('--pfs',document.getElementById('settingFontSize').value+'px');document.documentElement.style.setProperty('--plh',document.getElementById('settingLineHeight').value);document.documentElement.style.setProperty('--pls',document.getElementById('settingLetterSpacing').value+'px');}
['settingUnitMode','settingFontSize','settingLineHeight','settingLetterSpacing','settingSfxEnabled','settingSfxStyle','settingSfxVolume'].forEach(id=>{document.getElementById(id).addEventListener('change',saveSettings);document.getElementById(id).addEventListener('input',saveSettings);});

/* #6: Admin text management with count display */
async function refreshAdminTextList(){
  const r=await api('/api/texts');if(!r?.ok)return;
  adminAllTexts=r.texts;
  const af=document.getElementById('adminLangFilter'),pv=af.value;
  const langs=[...new Set(r.texts.map(t=>t.language||'').filter(Boolean))];
  af.innerHTML='<option value="">전체</option>';
  langs.forEach(l=>{const o=document.createElement('option');o.value=l;o.textContent=l;af.appendChild(o);});
  af.value=pv;
  renderAdminList();
}
document.getElementById('adminLangFilter').addEventListener('change',renderAdminList);
function renderAdminList(){
  const lang=document.getElementById('adminLangFilter').value;
  const filtered=lang?adminAllTexts.filter(t=>(t.language||'')===lang):adminAllTexts;
  document.getElementById('adminTotalCount').textContent='(총 '+filtered.length+'개)';
  document.getElementById('adminSelCount').textContent='';
  const l=document.getElementById('adminTextList');
  if(filtered.length===0){l.innerHTML='<div style="padding:20px;text-align:center;color:#94a3b8">텍스트 없음</div>';return;}
  l.innerHTML=filtered.map(t=>'<div class="admin-text-item"><label style="display:flex;align-items:center;gap:6px;cursor:pointer;flex-shrink:0"><input type="checkbox" class="admin-chk" data-id="'+t.id+'" onchange="updateAdminSelCount()"></label><div class="admin-text-info"><div class="admin-text-title">'+esc(t.title)+'</div><div class="admin-text-meta">'+esc(t.language)+' · '+t.content.length+'자</div></div><div class="admin-text-actions"><button class="btn-primary" onclick="showEditTextModal('+t.id+')">편집</button><button class="btn-danger" onclick="doDeleteTextDirect('+t.id+',\''+esc(t.title).replace(/'/g,"\\'")+'\')">삭제</button></div></div>').join('');
}
function adminSelectAll(checked){document.querySelectorAll('.admin-chk').forEach(c=>c.checked=checked);updateAdminSelCount();}
function updateAdminSelCount(){const sel=document.querySelectorAll('.admin-chk:checked').length;const total=document.querySelectorAll('.admin-chk').length;document.getElementById('adminSelCount').textContent=sel>0?sel+'/'+total+'개 선택':'';}
async function adminDeleteSelected(){
  const ids=[...document.querySelectorAll('.admin-chk:checked')].map(c=>parseInt(c.dataset.id));
  if(ids.length===0){alert('삭제할 텍스트를 선택하세요.');return;}
  if(!confirm(ids.length+'개의 텍스트를 삭제하시겠습니까?'))return;
  for(const id of ids){await api('/api/texts/'+id,'DELETE');}
  await loadTexts();refreshAdminTextList();
}
function showAddTextModal(){document.getElementById('editTextTitle').textContent='새 텍스트 추가';document.getElementById('editTextId').value='';document.getElementById('editTextName').value='';document.getElementById('editTextLang').value='한국어';document.getElementById('editTextContent').value='';document.getElementById('btnDeleteText').style.display='none';openModal('editTextModal');document.getElementById('editTextName').focus();}
function showEditTextModal(id){const t=allTexts.find(x=>x.id===id)||adminAllTexts.find(x=>x.id===id);if(!t)return;document.getElementById('editTextTitle').textContent='텍스트 편집';document.getElementById('editTextId').value=id;document.getElementById('editTextName').value=t.title;document.getElementById('editTextLang').value=t.language||'한국어';document.getElementById('editTextContent').value=t.content;document.getElementById('btnDeleteText').style.display='';openModal('editTextModal');}
async function doSaveText(){const id=document.getElementById('editTextId').value,ti=document.getElementById('editTextName').value.trim(),la=document.getElementById('editTextLang').value,co=document.getElementById('editTextContent').value.trim(),m=document.getElementById('editTextMsg');if(!ti||!co){m.textContent='제목과 내용 필요';return;}let r;if(id)r=await api('/api/texts/'+id,'PUT',{title:ti,content:co,language:la});else r=await api('/api/texts','POST',{title:ti,content:co,language:la});if(r?.ok){m.className='modal-msg success';m.textContent='저장 완료!';await loadTexts();refreshAdminTextList();setTimeout(()=>closeModal('editTextModal'),600);}else{m.className='modal-msg';m.textContent=r?.msg||'실패';}}
async function doDeleteText(){const id=document.getElementById('editTextId').value;if(!id)return;if(!confirm('삭제하시겠습니까?'))return;const r=await api('/api/texts/'+id,'DELETE');if(r?.ok){closeModal('editTextModal');await loadTexts();refreshAdminTextList();}}
async function doDeleteTextDirect(id,title){if(!confirm('"'+title+'" 삭제?'))return;const r=await api('/api/texts/'+id,'DELETE');if(r?.ok){await loadTexts();refreshAdminTextList();}}

/* Pause */
function doPause(manual=false,silent=false){if(!started||paused)return;paused=true;manualPause=manual;pauseStartTime=Date.now();
  if(!silent){document.getElementById('pauseOverlay').classList.add('active');}
  document.getElementById('pauseStatus').style.display='';}
function doResume(){if(!paused)return;paused=false;manualPause=false;if(pauseStartTime){totalPausedMs+=(Date.now()-pauseStartTime);pauseStartTime=null;}document.getElementById('pauseOverlay').classList.remove('active');document.getElementById('pauseStatus').style.display='none';if(lineInputs[currentLineIdx])lineInputs[currentLineIdx].focus();}

/* #9: Line split — strip leading blanks from EACH line */
function splitTextToLines(content){
  if(unitMode==='paragraph'){const p=content.split('\n').filter(l=>l.length>0);if(p.length>0){p[0]=stripLeadingBlanks(p[0]);return p.filter(l=>l.length>0);}return[stripLeadingBlanks(content)];}
  const raw=content.split('\n').filter(l=>l.length>0);if(raw.length===0)return[stripLeadingBlanks(content)];
  /* strip leading blanks from first raw line */
  raw[0]=stripLeadingBlanks(raw[0]);
  const m=document.createElement('div');m.style.cssText='position:absolute;visibility:hidden;white-space:nowrap;font-family:var(--pf);font-size:var(--pfs);letter-spacing:var(--pls);padding:0 14px;';document.body.appendChild(m);const maxW=(document.getElementById('linePracticeArea').clientWidth||900)-32;const result=[];for(const r of raw){if(!r)continue;let ln='';for(let i=0;i<r.length;i++){const t=ln+r[i];m.textContent=t;if(m.offsetWidth>maxW&&ln.length>0){result.push(ln);ln=r[i];}else{ln=t;}}if(ln)result.push(ln);}document.body.removeChild(m);return result.length>0?result:[content];}

/* Practice */
function startPractice(){const s=document.getElementById('textSelect'),id=parseInt(s.value);if(!id){alert('텍스트를 선택하세요.');return;}currentText=texts.find(t=>t.id===id);if(!currentText)return;resetPractice();practicing=true;started=false;paused=false;keystrokes=0;startTime=null;totalPausedMs=0;lines=splitTextToLines(currentText.content);currentLineIdx=0;const area=document.getElementById('linePracticeArea');area.innerHTML='';lineInputs=[];lineDisplays=[];lineBlocks=[];
lines.forEach((line,idx)=>{const block=document.createElement('div');block.className='line-block';const origDiv=document.createElement('div');origDiv.className='line-original';for(let i=0;i<line.length;i++){const sp=document.createElement('span');sp.className='ch'+(idx===0&&i===0?' current':'');sp.textContent=line[i];origDiv.appendChild(sp);}const inp=document.createElement('input');inp.type='text';inp.className='line-input';inp.autocomplete='off';inp.spellcheck=false;inp.disabled=(idx!==0);if(idx===0)inp.classList.add('active-line');block.appendChild(origDiv);block.appendChild(inp);area.appendChild(block);lineInputs.push(inp);lineDisplays.push(origDiv);lineBlocks.push(block);
inp.addEventListener('compositionstart',()=>{inp._composing=true;});inp.addEventListener('compositionend',()=>{inp._composing=false;handleLineInput(idx);});inp.addEventListener('input',()=>{if(!inp._composing)handleLineInput(idx);});inp.addEventListener('keydown',e=>handleLineKeydown(e,idx));
inp.addEventListener('mousedown',e=>{if(!practicing)return;if(paused){doResume();e.preventDefault();return;}if(idx!==currentLineIdx){switchToLine(idx);e.preventDefault();}});});
document.getElementById('practiceArea').style.display='';document.getElementById('practiceMsg').style.display='none';document.getElementById('statsBar').style.display='';document.getElementById('prepArea').style.display='';const pr=document.getElementById('prepInput');pr.value='';pr.focus();}

function switchToLine(toIdx){if(toIdx===currentLineIdx)return;lineInputs[currentLineIdx].classList.remove('active-line');currentLineIdx=toIdx;lineInputs[toIdx].disabled=false;lineInputs[toIdx].classList.add('active-line');lineInputs[toIdx].focus();updateCursorDisplay(toIdx);}
function updateCursorDisplay(idx){const spans=lineDisplays[idx].children,typed=lineInputs[idx].value;for(let i=0;i<spans.length;i++){spans[i].classList.remove('current');if(i===typed.length)spans[i].classList.add('current');}}

/* #7: prepInput — Enter or ArrowDown starts timing */
document.getElementById('prepInput').addEventListener('keydown',e=>{
  if(e.key==='Enter'||e.key==='ArrowDown'){
    e.preventDefault();if(!practicing)return;
    started=true;startTime=Date.now();timerInterval=setInterval(updateStats,200);
    document.getElementById('prepArea').style.display='none';
    if(lineInputs[0])lineInputs[0].focus();
  }
});

/* #8: handleLineKeydown — ESC pause fixed with stopPropagation */
function handleLineKeydown(e,idx){if(!practicing)return;
if(e.key==='Escape'){e.preventDefault();e.stopPropagation();if(paused)doResume();else doPause(true);return;}
if(paused){const ig=['Shift','Control','Alt','Meta','CapsLock','NumLock','ScrollLock'];if(!ig.includes(e.key)){e.preventDefault();doResume();}return;}
/* auto-start */
if(!started&&!e.ctrlKey&&!e.altKey&&!e.metaKey&&!['F10','F11','F12','Escape','Shift','Control','Alt','Meta'].includes(e.key)){started=true;startTime=Date.now();timerInterval=setInterval(updateStats,200);document.getElementById('prepArea').style.display='none';}
/* block leading space */
if((e.key===' '||e.code==='Space')&&lineInputs[idx].value.length===0){e.preventDefault();return;}
/* SFX + keystroke count */
if(e.key.length===1||e.key==='Backspace'||e.key==='Enter'||e.key==='Process'||e.keyCode===229){keystrokes++;playSfx();}
/* Tab */
if(e.key==='Tab'&&!e.shiftKey){e.preventDefault();keystrokes++;if(idx<lines.length-1)moveToLine(idx+1,idx);return;}
if(e.key==='Tab'&&e.shiftKey){e.preventDefault();keystrokes++;if(idx>0)moveToLine(idx-1,idx);return;}
/* Arrow up/down */
if(e.key==='ArrowUp'){e.preventDefault();if(idx>0)switchToLine(idx-1);return;}
if(e.key==='ArrowDown'){e.preventDefault();if(idx<lines.length-1)switchToLine(idx+1);return;}
/* BackSpace at beginning */
if(e.key==='Backspace'&&lineInputs[idx].selectionStart===0&&lineInputs[idx].selectionEnd===0){if(idx>0){e.preventDefault();moveToLine(idx-1,idx);return;}}
/* Enter */
if(e.key==='Enter'){e.preventDefault();if(idx<lines.length-1)moveToLine(idx+1,idx,true);else stopPractice();return;}}

function moveToLine(toIdx,fromIdx,markComplete=false){if(markComplete)lineBlocks[fromIdx].classList.add('completed');lineInputs[fromIdx].disabled=true;lineInputs[fromIdx].classList.remove('active-line');currentLineIdx=toIdx;lineInputs[toIdx].disabled=false;lineInputs[toIdx].classList.add('active-line');lineInputs[toIdx].focus();updateCursorDisplay(toIdx);lineBlocks[toIdx].scrollIntoView({behavior:'smooth',block:'center'});}

function handleLineInput(idx){if(!practicing||paused)return;const inp=lineInputs[idx];if(inp._composing)return;let typed=inp.value;
/* #9: strip leading blanks on every input */
if(typed.length>0&&/^[\s\u3000\u00A0]/.test(typed)){typed=stripLeadingBlanks(typed);inp.value=typed;}
const target=lines[idx],spans=lineDisplays[idx].children;
/* auto advance on overflow */
if(typed.length>target.length){
  const overflow=typed.slice(target.length);
  inp.value=typed.slice(0,target.length);typed=inp.value;
  refreshHighlights(idx,typed,target,spans);updateStats();
  if(idx<lines.length-1){lineBlocks[idx].classList.add('completed');moveToLine(idx+1,idx,false);
    const next=overflow.replace(/^ /,'');
    if(next){lineInputs[idx+1].value=next;handleLineInput(idx+1);}
  }else{stopPractice();}
  return;
}
refreshHighlights(idx,typed,target,spans);updateStats();
if(typed.length>0){const tN=normalizeFullwidth(typed),gN=normalizeFullwidth(target);if(tN===gN&&idx<lines.length-1){lineBlocks[idx].classList.add('completed');moveToLine(idx+1,idx,false);}}}

function refreshHighlights(idx,typed,target,spans){for(let i=0;i<target.length;i++){const sp=spans[i];if(!sp)continue;sp.className='ch';if(i<typed.length){const tn=normalizeFullwidth(target[i]),un=normalizeFullwidth(typed[i]);if(un===tn)sp.className='ch correct';else sp.className=target[i]===' '?'ch space-incorrect':'ch incorrect';}else if(i===typed.length){sp.className='ch current';}}}

function resetPractice(){practicing=false;started=false;paused=false;manualPause=false;startTime=null;totalPausedMs=0;pauseStartTime=null;if(timerInterval){clearInterval(timerInterval);timerInterval=null;}keystrokes=0;currentLineIdx=0;lines=[];lineInputs=[];lineDisplays=[];lineBlocks=[];document.getElementById('linePracticeArea').innerHTML='';document.getElementById('statTime').textContent='0:00';document.getElementById('statCpm').textContent='0';document.getElementById('statKpm').textContent='0';document.getElementById('statAcc').textContent='0%';document.getElementById('statProgress').textContent='0%';document.getElementById('statChars').textContent='0';document.getElementById('statKeys').textContent='0';document.getElementById('pauseOverlay').classList.remove('active');document.getElementById('pauseStatus').style.display='none';}

function stopPractice(){if(!practicing)return;practicing=false;started=false;if(paused&&pauseStartTime){totalPausedMs+=(Date.now()-pauseStartTime);pauseStartTime=null;}paused=false;if(timerInterval){clearInterval(timerInterval);timerInterval=null;}lineInputs.forEach(i=>{i.disabled=true;i.classList.remove('active-line');});document.getElementById('pauseOverlay').classList.remove('active');document.getElementById('pauseStatus').style.display='none';showResults();}

function getElapsed(){if(!startTime)return 0;let pe=totalPausedMs;if(paused&&pauseStartTime)pe+=(Date.now()-pauseStartTime);return Math.max(0,(Date.now()-startTime-pe))/1000;}

/* #2: updateStats with total chars + total keystrokes */
function updateStats(){const el=getElapsed(),mn=Math.floor(el/60),sc=Math.floor(el%60);document.getElementById('statTime').textContent=mn+':'+String(sc).padStart(2,'0');if(el<=0)return;let tc=0,tco=0,ttl=0;for(let i=0;i<lines.length;i++){const ty=lineInputs[i]?normalizeFullwidth(lineInputs[i].value):'',tg=normalizeFullwidth(lines[i]),cm=Math.min(ty.length,tg.length);for(let j=0;j<cm;j++)if(ty[j]===tg[j])tc++;tco+=cm;ttl+=(lineInputs[i]?lineInputs[i].value.length:0);}const ttg=lines.reduce((s,l)=>s+l.length,0);document.getElementById('statCpm').textContent=Math.round(tc/(el/60));document.getElementById('statKpm').textContent=Math.round(keystrokes/(el/60));document.getElementById('statAcc').textContent=(tco>0?Math.round(tc/tco*100):0)+'%';document.getElementById('statProgress').textContent=Math.min(ttg>0?Math.round(ttl/ttg*100):0,100)+'%';document.getElementById('statChars').textContent=ttl;document.getElementById('statKeys').textContent=keystrokes;}

/* Focus pause/resume — #10: scroll buttons don't steal focus */
document.addEventListener('focusin',e=>{if(!practicing||!started)return;if(paused&&!manualPause&&lineInputs.includes(e.target))doResume();});
document.addEventListener('focusout',e=>{if(!practicing||!started||paused)return;setTimeout(()=>{if(!practicing||!started||paused)return;const a=document.activeElement;if(lineInputs.includes(a)||a===document.getElementById('prepInput'))return;
const activeTab=document.querySelector('.tab-btn.active')?.dataset.tab;
if(activeTab!=='practice')return;
/* #10: check if focus went to scroll btn or body (scroll buttons use preventDefault) */
if(a===document.body||a.classList.contains('scroll-btn'))return;
doPause(false);},200);});
document.getElementById('pauseOverlay').addEventListener('click',()=>{if(paused)doResume();});

/* Results */
function showResults(){const el=getElapsed();let tc=0,tco=0,ttl=0;for(let i=0;i<lines.length;i++){const ty=lineInputs[i]?normalizeFullwidth(lineInputs[i].value):'',tg=normalizeFullwidth(lines[i]),cm=Math.min(ty.length,tg.length);for(let j=0;j<cm;j++)if(ty[j]===tg[j])tc++;tco+=cm;ttl+=(lineInputs[i]?lineInputs[i].value.length:0);}const ttg=lines.reduce((s,l)=>s+l.length,0);
const cpm=el>0?Math.round(tc/(el/60)):0,kpm=el>0?Math.round(keystrokes/(el/60)):0,acc=tco>0?Math.round(tc/tco*1000)/10:0,prog=ttg>0?Math.round(ttl/ttg*1000)/10:0;
document.getElementById('resCpm').textContent=cpm;document.getElementById('resKpm').textContent=kpm;document.getElementById('resAcc').textContent=acc+'%';document.getElementById('resProgress').textContent=Math.min(prog,100)+'%';document.getElementById('resTime').textContent=el.toFixed(1)+'초';document.getElementById('resChars').textContent=ttl;
window._lastResult={cpm,kpm,acc,progress:Math.min(prog,100),elapsed:el,chars:ttl,input_chars:ttl};document.getElementById('rankSubmitMsg').textContent='';if(currentUser)document.getElementById('rankSubmitArea').style.display='';openModal('resultsModal');}

async function submitRanking(){if(!currentUser||!window._lastResult||!currentText)return;const tw=document.getElementById('resTypewriter').value.trim();if(!tw){document.getElementById('rankSubmitMsg').textContent="타자기 구분을 입력하세요.";return;}const bk=await sha1(currentText.content);const r=await api('/api/rankings','POST',{board_key:bk,board_name:currentText.title,typewriter:tw,cpm:window._lastResult.cpm,kpm:window._lastResult.kpm,acc:window._lastResult.acc,completion:window._lastResult.progress,chars:window._lastResult.chars,input_chars:window._lastResult.input_chars,elapsed:window._lastResult.elapsed,created_at:new Date().toLocaleString('sv-SE').replace('T',' '),created_ts:Math.floor(Date.now()/1000)});const m=document.getElementById('rankSubmitMsg');if(r?.ok){m.className='modal-msg success';m.textContent='등록 완료!';}else{m.className='modal-msg';m.textContent=r?.msg||'실패';}}
async function sha1(t){const d=new TextEncoder().encode(t),h=await crypto.subtle.digest('SHA-1',d);return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('');}

/* Rankings */
async function loadRankings(){const r=await api('/api/rankings');if(!r?.ok)return;const s=document.getElementById('rankBoardSelect'),cv=s.value;s.innerHTML='<option value="">전체</option>';const meta=r.meta||{};for(const[k,m]of Object.entries(meta)){const o=document.createElement('option');o.value=k;o.textContent=m.name||k;s.appendChild(o);}s.value=cv;const fb=s.value;let all=[];for(const[bk,rows]of Object.entries(r.boards||{})){if(fb&&bk!==fb)continue;const bn=meta[bk]?.name||bk;for(const row of rows)all.push({...row,_boardName:bn});}all.sort((a,b)=>b.cpm-a.cpm||b.created_ts-a.created_ts);const tb=document.getElementById('rankBody');if(all.length===0){tb.innerHTML='<tr><td colspan="9" style="text-align:center;padding:30px;color:#94a3b8">데이터 없음</td></tr>';return;}tb.innerHTML=all.slice(0,100).map((r,i)=>'<tr><td class="rank-num">'+(i+1)+'</td><td>'+esc(r.nickname)+'</td><td>'+esc(r.typewriter)+'</td><td><strong>'+r.cpm+'</strong></td><td>'+r.kpm+'</td><td>'+(typeof r.acc==='number'?r.acc.toFixed(1):r.acc)+'%</td><td>'+(typeof r.completion==='number'?r.completion.toFixed(1):r.completion)+'%</td><td style="max-width:120px;overflow:hidden;text-overflow:ellipsis">'+esc(r._boardName)+'</td><td>'+esc(r.created_at||'')+'</td></tr>').join('');}
document.getElementById('rankBoardSelect').addEventListener('change',loadRankings);
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}

/* #8: Global hotkeys — ESC fixed */
document.addEventListener('keydown',e=>{
  if(document.querySelector('.modal-overlay.active:not(#pauseOverlay)')){
    if(e.key==='Enter'&&document.getElementById('resultsModal').classList.contains('active')){closeModal('resultsModal');e.preventDefault();}return;}
  if(e.key==='Escape'&&practicing&&started){e.preventDefault();if(paused)doResume();else doPause(true);return;}
  if(paused&&practicing&&started){const ig=['Shift','Control','Alt','Meta','CapsLock','NumLock','ScrollLock','F1','F2','F3','F4','F5','F6','F7','F8','F9'];if(!ig.includes(e.key)&&e.key!=='Escape'){e.preventDefault();doResume();return;}}
  if(e.key==='F10'){e.preventDefault();startPractice();}if(e.key==='F11'){e.preventDefault();resetPractice();}if(e.key==='F12'){e.preventDefault();stopPractice();}});

/* Init */
(async function init(){loadSettings();preloadAllSfx();try{const c=JSON.parse(localStorage.getItem('cachedTexts'));if(c?.texts?.length>0)populateTextSelect(c.texts,c.languages||[]);}catch(e){}try{const s=JSON.parse(localStorage.getItem('auth'));if(s?.token)currentUser=s;}catch(e){}updateAuthUI();const tp=loadTexts(),rp=loadRankings();if(currentUser)api('/api/rankings').then(r=>{if(!r){currentUser=null;localStorage.removeItem('auth');updateAuthUI();}});await Promise.all([tp,rp]);})();
</script>
</body>
</html>
